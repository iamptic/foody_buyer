(()=>{const e=new URLSearchParams(location.search),t=e.get("api")||"http://localhost:8000",n={offers:document.getElementById("offers"),empty:document.getElementById("empty"),search:document.getElementById("search"),sort:document.getElementById("sort"),refresh:document.getElementById("refreshBtn"),reserveModal:document.getElementById("reserveModal"),reserveForm:document.getElementById("reserveForm"),reserveOffer:document.getElementById("reserveOffer"),buyerName:document.getElementById("buyerName"),okModal:document.getElementById("okModal"),reserveCode:document.getElementById("reserveCode"),reserveUntil:document.getElementById("reserveUntil"),okClose:document.getElementById("okClose"),toast:document.getElementById("toast"),qrCanvas:document.getElementById("qrCanvas")};let a=[],o=null;const d=e=>{n.toast.textContent=e,n.toast.style.display="block",setTimeout(()=>n.toast.style.display="none",2200)},s=e=>new Intl.NumberFormat("ru-RU").format(e)+" ₽",i=e=>new Date(e).toLocaleString("ru-RU",{hour:"2-digit",minute:"2-digit",day:"2-digit",month:"2-digit"}),l=e=>{const t=document.createElement("div");t.className="offer";const n=e.photo_url?`<img class="thumb" src="${e.photo_url}" alt="${e.title}">`:'<div class="thumb"></div>';return t.innerHTML=`${n}
      <div class="body">
        <div class="title"><b>${e.title}</b></div>
        <div class="meta">${e.restaurant}</div>
        <div class="meta">До: ${i(e.expires_at)}</div>
        <div class="price">${s(e.price)} • Остаток: ${e.quantity}</div>
        <div class="ops"><button class="btn primary" data-res="${e.id}" ${e.quantity<=0?"disabled":""}>Забронировать</button></div>
      </div>`,t.querySelector("[data-res]").onclick=(()=>c(e)),t},r=()=>{const e=(n.search.value||"").toLowerCase(),t=n.sort.value;let r=a.slice();e&&(r=r.filter(t=>t.title.toLowerCase().includes(e)||(t.restaurant||"").toLowerCase().includes(e))),"price"===t?r.sort(((e,t)=>e.price-t.price)):"time"===t?r.sort(((e,t)=>new Date(e.expires_at)-new Date(t.expires_at))):r.sort(((e,t)=>t.id-e.id)),n.offers.innerHTML="",r.length?n.empty.classList.add("hidden"):n.empty.classList.remove("hidden"),r.forEach((e=>n.offers.appendChild(l(e))))},u=async()=>{try{const e=await fetch(`${t}/offers`);a=await e.json(),r()}catch{d("Сервер недоступен")}},c=e=>{o=e,n.reserveOffer.textContent=`${e.restaurant} • ${e.title} — ${s(e.price)}`,n.buyerName.value="",n.reserveModal.showModal()};n.reserveForm.addEventListener("submit",(async e=>{if(e.preventDefault(),!o)return;try{const e=await fetch(`${t}/reserve`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({offer_id:o.id,buyer_name:n.buyerName.value.trim()||null})}),a=await e.json();if(a.code){const e=a.code;n.reserveCode.textContent=e,n.reserveUntil.textContent="Действует до: "+i(a.expires_at),n.reserveModal.close(),n.okModal.showModal();try{new QRCode(n.qrCanvas,{text:`FOODY:${e}`,width:180,height:180,margin:1})}catch(a){const e=n.qrCanvas.getContext("2d");e.clearRect(0,0,n.qrCanvas.width,n.qrCanvas.height),e.font="16px system-ui",e.fillText("FOODY:"+e,10,90)}u()}else d("Ошибка: "+JSON.stringify(a))}catch{d("Ошибка сети")}})),n.okClose.onclick=(()=>n.okModal.close()),n.search.addEventListener("input",r),n.sort.addEventListener("change",r),n.refresh.onclick=(()=>u()),u();})();